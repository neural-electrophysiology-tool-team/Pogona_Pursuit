<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Arena</title>
    <script type="text/javascript" src="{{ url_for('static', filename='jquery.js') }}"></script>
    <!--    <script type="text/javascript" src="{{ url_for('static', filename='popper.min.js') }}"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
            integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap-4.5.0/css/bootstrap.css')}}">
    <script type="text/javascript"
            src="{{ url_for('static', filename='Bootstrap-4-Multi-Select-BsMultiSelect/dist/js/BsMultiSelect.js') }}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
</head>

<body>
<div class="row">
    <div class="col">
        <h1 class="p-2" style="font-size: 4em; text-align: center; margin-bottom: 0.5em">Pogona Pursuit</h1>
        <div class="row" id="controls-panel">
            {% include "management/start_experiment.html" %}
            {% include "management/cameras_record.html" %}
            {% include "management/events.html" %}
        </div>
        <pre class="row" id="record-output"></pre>
    </div>
    <div class="col">
        {% include "management/stream.html" %}
    </div>
    {% include "management/footer.html" %}
</div>

</body>

<script>
  $(function () {
    let $bugTypeSelect = $("#bugTypeSelect")
    let $rewardBugDiv = $("#rewardBugDiv")
    $bugTypeSelect.bsMultiSelect()
    $bugTypeSelect.change(function () {
      $("#rewardBugSelect option").remove()
      if (!$bugTypeSelect.val() || $bugTypeSelect.val().length <= 1) {
        $rewardBugDiv.hide()
      } else {
        let $el = $("#rewardBugSelect")
        $("#bugTypeSelect option").each(function () {
          if (this.selected) {
            $el.append($("<option></option>").attr("value", this.value).text(this.text)).attr('selected', true);
          }
        });
        $el.bsMultiSelect("UpdateData")
        $rewardBugDiv.show()
      }
    })

    let $isAntiClockWiseDiv = $("#isAntiClockWiseDiv")
    let $targetDrift = $("#targetDrift")
    $("#movementTypeSelect").change(function () {
      let movementType = $("#movementTypeSelect").val()
      if (movementType === 'circle') {
        $isAntiClockWiseDiv.show()
      } else {
        $isAntiClockWiseDiv.hide()
      }
      if (['random walk + drift', 'low horizontal', 'low horizontal + noise'].indexOf(movementType) !== -1) {
        $targetDrift.show()
      } else {
        $targetDrift.hide()
      }
    })

    $("#experimentTypeSelect").change(function () {
      if (isMediaExperiment()) {
        $(".media-options").show()
        $(".bugs-options").hide()
      } else {
        $(".bugs-options").show()
        $rewardBugDiv.hide()
        $isAntiClockWiseDiv.hide()
        $(".media-options").hide()
      }
    })

    $.get('/get_experiment', function (data) {
      $("#currentExperimentName").text(data)
    })

    $("#stream").click(function () {
      $.post('/set_stream_camera', {camera: $("#selectStreamCamera").val()}).done(function (camera) {
        $("#selectStreamCamera").prop("disabled", true);
        $(`input[value=${camera}]`).prop("disabled", true);
        $("#stream_img").attr("src", "{{ url_for('video_feed') }}")
      })
    });
    $("#stopStream").click(function () {
      $("#stream_img").attr("src", "{{ url_for('static', filename='video_placeholder.jpg') }}")
      const sCamera = $("#selectStreamCamera");
      $(`input[value=${sCamera.val()}]`).prop("disabled", false);
      sCamera.prop("disabled", false);
    });
    $("#stopExperiment").click(function () {
      $.get('/stop_experiment', function (data) {
        appendOutput(data)
        appendOutput('wait for trial to finish...')
        $.get('/get_experiment', function (data) {
          appendOutput(data)
        });
      })
    });
    $("#experiment_form").submit(function (event) {
      event.preventDefault();
      params = {
        name: $("#experimentName").val(),
        animal_id: $("#animalId").val(),
        cameras: getCheckedCameras(),
        trial_duration: Number($("#experimentTrialDuration").val()),
        num_trials: Number($("#experimentNumTrials").val()),
        iti: Number($("#experimentITI").val()),
        experiment_type: $("#experimentTypeSelect").val()
      }
      let extraParams = {}
      if (isMediaExperiment()) {
        extraParams = {
            media_url: $("#media-url").val()
        }
      } else {
        let bugTypes = $("#bugTypeSelect").val().join(',')
        let rewardBugs = $("#rewardBugSelect").val()
        extraParams = {
            reward_type: $("#rewardTypeSelect").val(),
            is_use_predictions: $("#use_predictions").is(":checked"),
            bug_types: bugTypes,
            reward_bugs: rewardBugs ? rewardBugs.join(',') : bugTypes,
            bug_speed: Number($("#bugSpeed").val()),
            movement_type: $("#movementTypeSelect").val(),
            time_between_bugs: Number($("#timeBetweenBugs").val()),
            is_anticlockwise: $("#isAntiClockWise").is(":checked"),
            target_drift: $("#targetDriftSelect").val()
        }
      }
      Object.assign(params, extraParams)
      $.ajax({
        url: "/start_experiment",
        type: "POST",
        data: JSON.stringify(params),
        contentType: "application/json",
        beforeSend: function () {
          $("#record-output").text('>> initializing experiment...')
        },
        success: function (res) {
          // $("#record-output").text(res.responseText)
          $.get('/get_experiment', function (data) {
            $("#currentExperimentName").text(data)
          });
        }
      })
    });
    $("#record_form").submit(function (event) {
      event.preventDefault();
      $.ajax({
        url: "/record",
        type: "POST",
        data: JSON.stringify(Object.assign({
          exposure: Number($("#exposure").val()),
          folder_prefix: $("#videoOutputPrefix").val(),
          cameras: getCheckedCameras(),
          is_use_predictions: $("#use_predictions").is(":checked")
        }, getAcquireStop())),
        contentType: "application/json",
        beforeSend: function () {
          $("#record-output").text('recording...')
        },
        complete: function (res) {
          $("#record-output").text(res.responseText)
        }
      })
    });
    $("#stopRecord").click(function () {
      $.get("/manual_record_stop", function (data) {
        $("#record-output").text(data)
      })
    })

    const AcquireStopWithValue = ['num_frames', 'record_time'];
    $("#acquireStopSelect").change(function (e) {
      let isValued = AcquireStopWithValue.indexOf($("#acquireStopSelect").val()) !== -1;
      let acqValue = $("#acquireStopValue");
      if (isValued) {
        acqValue.show()
      } else {
        acqValue.hide()
      }
      acqValue.prop('required', isValued);
    })
    $("#camerasInfo").click(function () {
      $.get('/cameras_info', function (data) {
        $("#record-output").text(data)
      })
    })
    $("#init_bugs").click(function (e) {
      $.ajax({
        url: "/init_bugs",
        type: "POST",
        data: JSON.stringify({
          numOfBugs: 1,
          speed: Number($("#bugSpeed").val()),
          bugTypes: $("#bugTypeSelect").val(),
          rewardBugs: $("#rewardBugSelect").val() ? $("#rewardBugSelect").val() : $("#bugTypeSelect").val(),
          movementType: $("#movementTypeSelect").val(),
          timeBetweenBugs: Number($("#timeBetweenBugs").val()),
          isAntiClockWise: $("#isAntiClockWise").is(":checked"),
          targetDrift: $("#targetDriftSelect").val()
        }),
        contentType: "application/json",
        complete: function (res) {
          appendOutput('>> Bugs initiated manually')
        }
      })
    })
    $("#hide_bugs").click(function (e) {
      $.get('/hide_bugs')
      appendOutput('>> Bugs stopped manually')
    })
    $("#calibrate").click(function (e) {
      $.get('/calibrate', function (data) {
        appendOutput(`>> Calibration: ${data}`)
      })
    })

    $("#reward").click(function (e) {
      $.get('/reward', function (data) {
        appendOutput('>> Reward sent manually')
      })
    })

    $("#led_light_on").click(function (e) {
      $.get('/led_light/on')
    })
    $("#led_light_off").click(function (e) {
      $.get('/led_light/off')
    })
    $("#display_on").click(function (e) {
      $.get('/display/on')
    })
    $("#display_off").click(function (e) {
      $.get('/display/off')
    })

    ////////////////////////////// MQTT ////////////////////////////////////
    let client = new Paho.MQTT.Client(location.hostname, 9001, "clientId");
    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;
    client.connect({onSuccess: onConnect});

    function onConnect() {
      client.subscribe("event/log/experiment");
      client.subscribe("event/log/touch");
    }

    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        appendOutput("MQTT connection lost:" + responseObject.errorMessage);
      }
    }

    function onMessageArrived(message) {
      let msg = message.payloadString
      if (message.destinationName === "event/log/touch") {
        msg = JSON.parse(msg)
        if (!msg['is_hit']) {
          return
        }
        msg = `Hit recorded on ${msg['bug_type']} location: ${msg['x']},${msg['y']} ${msg['is_reward_bug'] ? '(reward bug)' : ''}`
      }
      appendOutput(msg)
    }

    ///////////////////////////////////////////////////////////////////////
    // Functions

    function isMediaExperiment() {
      return $("#experimentTypeSelect").val() === 'media'
    }

    function getCheckedCameras() {
      let a = []
      $("#cams-checkboxes input").each(function (e) {
        if (this.checked && !this.disabled) {
          a.push(this.value)
        }
      });
      return a.join(',')
    }

    function getAcquireStop() {
      let d = {};
      d[$("#acquireStopSelect").val()] = Number($("#acquireStopValue").val());
      return d;
    }

    function appendOutput(msg) {
      $("#record-output").append(document.createTextNode('\n' + msg))
    }
  })
</script>

<style>
    body {
        padding: 20px;
    }

    #footer {
        position: fixed;
        right: 0;
        bottom: 0;
        text-align: center;
        padding: 1em;
    }

    #controls-panel {
        border-top: 1.5px solid black;
        border-bottom: 1.5px solid black;
        padding-top: 1em;
        padding-bottom: 1em;
    }
</style>

</html>